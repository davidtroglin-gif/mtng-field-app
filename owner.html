<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTNG Owner Dashboard</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background:#f6f7f8; }
    header { position: sticky; top:0; background:white; padding:12px 14px; border-bottom:1px solid #ddd; z-index:10; }
    main { padding: 14px; max-width: 1100px; margin: 0 auto; }
    .card { background:white; border:1px solid #e5e5e5; border-radius:12px; padding:12px; margin-bottom:12px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 220px; }
    label { display:block; font-weight:700; }
    input, select, button { width:100%; padding:10px; font-size:16px; margin-top:6px; box-sizing:border-box; }
    .small { font-size: 12px; color:#666; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #ddd; padding:8px; vertical-align: top; font-size: 13px; }
    th { background:#fafafa; text-align:left; }
    tr:hover { background:#f3f7ff; cursor:pointer; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; background:#fafafa; }
    .mediaGrid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    img { max-width:100%; border-radius:12px; border:1px solid #ddd; background:white; }
    .btnrow { display:flex; gap:10px; flex-wrap: wrap; }
    .btnrow button { flex:1; min-width: 160px; }
    code { font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    /* --- Notes modal --- */
.modalBack {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.35);
  display: none;
  align-items: center; justify-content: center;
  padding: 14px;
  z-index: 9999;
}
.modalCard {
  width: min(720px, 100%);
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.2);
}
.modalHead {
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  margin-bottom: 8px;
}
.modalTitle { font-weight: 800; }
.modalBody textarea{
  width: 100%;
  min-height: 160px;
  font-size: 16px;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid #ddd;
  box-sizing: border-box;
}
.modalBtns { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.modalBtns button { flex:1; min-width:140px; }
.noteIconBtn{
  width:auto;
  padding: 6px 10px;
  border-radius: 10px;
  border: 1px solid #ddd;
  background: #fafafa;
  cursor: pointer;
  font-size: 16px;
}
  .noteIconBtn:active { transform: scale(.98); }
    @media (max-width: 900px) {
      .mediaGrid { grid-template-columns: 1fr; }
    }
  </style>
</head>
  <body>
  <header>
    <div style="font-weight:800;">MTNG Owner Dashboard</div>
    <div class="small" id="status">Status: ‚Ä¶</div>
  </header>
  <div id="noteModalBack" class="modalBack">
  <div class="modalCard">
    <div class="modalHead">
      <div class="modalTitle" id="noteModalTitle">Notes</div>
      <button id="noteModalClose" type="button" style="width:auto;">Close</button>
    </div>

    <div class="modalBody">
      <textarea id="noteModalText" placeholder="No notes yet‚Ä¶" disabled></textarea>
    </div>

    <div class="modalBtns">
      <button id="noteModalEdit" type="button">Edit</button>
      <button id="noteModalSave" type="button" disabled>Save</button>
    </div>

    <div class="small" id="noteModalMeta" style="margin-top:8px;"></div>
  </div>
</div>
  <main>
    <div class="card">
      <div class="row">
        <div>
          <label>Search</label>
          <input id="q" placeholder="Customer, MLO, Register, Foreman, SubmissionId‚Ä¶" />
        </div>
        <div>
          <label>Page Type</label>
          <select id="pageType">
            <option value="">All</option>
            <option value="Leak Repair">Leak Repair</option>
            <option value="Mains">Mains</option>
            <option value="Retirement">Retirement</option>
            <option value="Services">Services</option>
          </select>
        </div>
        <div>
          <label>Actions</label>
          <button id="refresh" type="button">Refresh</button>
        </div>
      </div>
      <div class="small" id="meta"></div>
    </div>

    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Submissions</div>
      <div style="overflow:auto;">
        <table id="tbl">
          <thead>
            <tr>
              <th>Synced</th>
              <th>Job Type</th>
              <th>Customer</th>
              <th>Date</th>
              <th>MLO</th>
              <th>Register</th>
              <th>Foreman</th>
              <th>Status</th>
              <th>SubmissionId</th>
              <th>Edit</th>
              <th>Print</th>
              <!--th>Add Note</th-->
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" id="detailCard" style="display:none;">
      <div class="row" style="align-items:flex-end;">
        <div>
          <div style="font-weight:800; font-size:18px;" id="detailTitle">Details</div>
          <div class="small" id="detailMeta"></div>
        </div>
        <div class="btnrow">
          <button id="openPrint" type="button">Open Print</button>
          <button id="markPrinted" type="button">Printed</button>
          <button id="markSubmitted" type="button">Submitted</button>
          <button id="addNote" type="button">Add Note</button>
          <button id="closeDetail" type="button">Close</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Key Fields</div>
          <div id="kv"></div>
        </div>
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Repeaters (quick view)</div>
          <div class="small">Print layout formats these; this is just raw reference.</div>
          <pre id="rep" style="white-space:pre-wrap; font-size:12px; margin:8px 0 0;"></pre>
        </div>
      </div>

      <div class="mediaGrid" style="margin-top:10px;">
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Sketch</div>
          <div id="sketchLinks" class="small"></div>
          <img id="sketchImg" alt="Sketch" style="display:none;" />
        </div>
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Photos</div>
          <div id="photoLinks" class="small"></div>
          <div id="photoImgs"></div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div style="font-weight:700; margin-bottom:6px;">Raw JSON</div>
        <pre id="raw" style="white-space:pre-wrap; font-size:12px; margin:0;"></pre>
      </div>
    </div>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycby4A2Ci8N6IFLB7oORb7KKThB_jqW580SV0EvG67CZ1FFoudWgLttJ8PyOiqPMKXtDiEQ/exec";

    const statusEl = document.getElementById("status");
    const metaEl = document.getElementById("meta");
    const tbody = document.getElementById("tbody");

    const qEl = document.getElementById("q");
    const pageTypeEl = document.getElementById("pageType");
    

    const detailCard = document.getElementById("detailCard");
    const detailTitle = document.getElementById("detailTitle");
    const detailMeta = document.getElementById("detailMeta");
    const kv = document.getElementById("kv");
    const rep = document.getElementById("rep");
    const raw = document.getElementById("raw");
    const openPrintBtn = document.getElementById("openPrint");
    const closeDetailBtn = document.getElementById("closeDetail");

    const sketchImg = document.getElementById("sketchImg");
    const sketchLinks = document.getElementById("sketchLinks");
    const photoLinks = document.getElementById("photoLinks");
    const photoImgs = document.getElementById("photoImgs");

    const key = new URLSearchParams(location.search).get("key") || "";

    let items = [];
    let selectedId = "";
    let openingDetail = false;

    function setStatus(msg){
      statusEl.textContent = "Status: " + msg;
    }

    function fmtDate(v){
      if (!v) return "";
      const d = new Date(v);
      if (isNaN(d.getTime())) return String(v);
      return d.toLocaleString();
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    function attrEscape(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function normKey(k){
      return String(k ?? "").replace(/\s+/g, " ").trim();
    }

    // Aliases let owner dashboard show the same value even if the form label changed
    const FIELD_ALIASES = {
      "Date Completed": ["Date Completed", "Date Repair Completed", "Date Completed (Repair)"],
      "MTNG On-Site Personnel": ["MTNG On-Site Personnel", "MTNG On Site Personnel", "MTNG On-Site Personell", "MTNG On-Site Personnel "],
      "Foreman": ["Foreman"],
      "Accepted By": ["Accepted By", "Accepted by"],
      "Customer Name": ["Customer Name", "Customer"],
      "Register Number": ["Register Number", "Register #"],
      "MLO Number": ["MLO Number", "MLO #"],
      "Customer Address": ["Customer Address", "Address"],
      "Customer City": ["Customer City", "City"],
      "Customer County": ["Customer County", "County"],
      "Customer Phone": ["Customer Phone", "Phone"],
      "Service Address (if different than customers)": ["Service Address (if different than customers)", "Service Address"],
      "Date": ["Date"],
      "Contractor": ["Contractor"],
    };

    function getF(fields, label){
      if (!fields) return "";
      const want = FIELD_ALIASES[label] || [label];

      // Build a normalized lookup once per call (fields are small enough; OK)
      const map = {};
      Object.keys(fields).forEach(k => { map[normKey(k)] = fields[k]; });

      for (const candidate of want) {
        const v = map[normKey(candidate)];
        if (v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
      return "";
    }

    async function fetchJsonOrThrow(url, fetchOpts = {}) {
      const res = await fetch(url.toString(), { cache: "no-store", ...fetchOpts });
      const txt = await res.text();

      let json;
      try { json = JSON.parse(txt); }
      catch { throw new Error(`Not valid JSON. HTTP ${res.status}. First 160: ${txt.slice(0,160)}`); }

      if (!json.ok) throw new Error(json.error || "Request failed");
      return json;
    }

    async function fetchList(){
      if (!key) {
        setStatus("Missing owner key. Open as: owner.html?key=YOUR_OWNER_KEY");
        return;
      }

      setStatus("Loading list‚Ä¶");

      const url = new URL(API_URL);
      url.searchParams.set("action", "list");
      url.searchParams.set("key", key);
      url.searchParams.set("_", Date.now().toString()); // cache-bust

      const json = await fetchJsonOrThrow(url, { cache: "no-store" });
      items = json.items || [];

      setStatus(`Loaded ${items.length}`);
      renderTable();
    }

    function samePageType(a, b){
      return String(a ?? "").trim().toLowerCase() === String(b ?? "").trim().toLowerCase();
    }

    function matchesFilters(it){
      const q = (qEl.value || "").trim().toLowerCase();
      const pt = pageTypeEl.value || "";
    


      if (pt && !samePageType(it.pageType, pt)) return false;

      if (pw === "not-turned" && it.turnedInOn) return false;
      if (pw === "turned" && !it.turnedInOn) return false;
      if (pw === "not-printed" && it.printedAt) return false;
      if (pw === "printed" && !it.printedAt) return false;

      if (!q) return true;

      const hay = [
        it.customerName, it.date, it.mloNumber, it.registerNumber,
        it.foreman, it.acceptedBy, it.mtngOnSitePersonnel, it.dateCompleted,
        it.submissionId, it.pageType, it.status, it.printedBy, it.notes
      ].join(" ").toLowerCase();

      return hay.includes(q);
    }

    // ---- Notes Modal ----
const noteModalBack  = document.getElementById("noteModalBack");
const noteModalClose = document.getElementById("noteModalClose");
const noteModalTitle = document.getElementById("noteModalTitle");
const noteModalText  = document.getElementById("noteModalText");
const noteModalEdit  = document.getElementById("noteModalEdit");
const noteModalSave  = document.getElementById("noteModalSave");
const noteModalMeta  = document.getElementById("noteModalMeta");

let noteModalId = "";
let noteModalEditing = false;

function openNoteModal(submissionId){
  noteModalId = submissionId;
  noteModalEditing = false;

  const it = items.find(x => String(x.submissionId) === String(submissionId));
  const note = (it?.notes ?? "").toString();

  noteModalTitle.textContent = `Notes ‚Äî ${submissionId}`;
  noteModalText.value = note;

  // view mode defaults
  noteModalText.disabled = true;
  noteModalEdit.disabled = false;
  noteModalSave.disabled = true;

  noteModalMeta.textContent = it
    ? `Customer: ${it.customerName || ""} ‚Ä¢ Page: ${it.pageType || ""} ‚Ä¢ Synced: ${fmtDate(it.syncedAt)}`
    : "";

  // show modal
  noteModalBack.style.display = "flex";

  // helpful on tablet: scroll textarea into view
  setTimeout(() => noteModalText.scrollIntoView({ block: "nearest" }), 0);
}

 noteModalSave.addEventListener("click", async () => {
  if (!noteModalId) return;
  try {
    setStatus("Saving note‚Ä¶");
    await ownerPost("note", noteModalId, { note: noteModalText.value });

    const it = items.find(x => String(x.submissionId) === String(noteModalId));
    if (it) it.notes = noteModalText.value;

    await fetchList();

    setStatus("Note saved ‚úÖ");
    closeNoteModal(true);
  } catch (e) {
    setStatus("Error: " + e.message);
  }
});


function closeNoteModal(force = false){
  // if editing, avoid accidental close unless force
  if (!force && noteModalEditing) {
    const ok = confirm("You‚Äôre editing this note. Close without saving?");
    if (!ok) return;
  }
  noteModalBack.style.display = "none";
  noteModalId = "";
  noteModalEditing = false;
}

noteModalClose.addEventListener("click", () => closeNoteModal());
noteModalBack.addEventListener("click", (e) => {
  if (e.target === noteModalBack) closeNoteModal(); // click backdrop closes (with confirm if editing)
});
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && noteModalBack.style.display === "flex") closeNoteModal();
});


noteModalEdit.addEventListener("click", () => {
  noteModalEditing = true;
  noteModalText.disabled = false;
  noteModalText.focus();

  noteModalEdit.disabled = true;
  noteModalSave.disabled = false;
});

   function renderTable() {
  const filtered = items.filter(matchesFilters);
  metaEl.textContent = `Showing: ${filtered.length} of ${items.length}`;

  tbody.innerHTML = filtered.map(it => {
    const id = it.submissionId || "";
    const hasNote = (it.notes || "").toString().trim().length > 0;

    const editBtn = `
      <button type="button" class="noteIconBtn" data-edit-id="${attrEscape(id)}" title="Open details">‚úèÔ∏è</button>
    `;

    const printBtn = `
      <button type="button" class="noteIconBtn" data-print-id="${attrEscape(id)}" title="Open print">üñ®Ô∏è</button>
    `;

    const notesBtn = `
      <button type="button" class="noteIconBtn" data-note-id="${attrEscape(id)}"
        title="${hasNote ? "View / Edit note" : "Add note"}">
        ${hasNote ? "üìù" : "‚ûï"}
      </button>
    `;

    return `
      <tr data-id="${attrEscape(id)}">
        <td>${escapeHtml(fmtDate(it.syncedAt))}</td>
        <td>${escapeHtml(it.pageType || "")}</td>
        <td>${escapeHtml(it.customerName || "")}</td>
        <td>${escapeHtml(it.date || "")}</td>
        <td>${escapeHtml(it.mloNumber || "")}</td>
        <td>${escapeHtml(it.registerNumber || "")}</td>
        <td>${escapeHtml(it.foreman || "")}</td>
        <td><span class="pill">${escapeHtml(it.status || "")}</span></td>
        <td><code>${escapeHtml(id)}</code></td>

        <td style="text-align:center;">${editBtn}</td>
        <td style="text-align:center;">${printBtn}</td>
        <td style="text-align:center;">${notesBtn}</td>
      </tr>
    `;
  }).join("");
}


   // Row click (single handler)
tbody.addEventListener("click", (e) => {
  const tr = e.target.closest("tr");
  if (!tr) return;

  const rowId = tr.dataset.id;
  if (!rowId) return;

  const noteBtn = e.target.closest("[data-note-id]");
  if (noteBtn) {
    e.preventDefault();
    e.stopPropagation();
    openNoteModal(noteBtn.getAttribute("data-note-id"));
    return;
  }

  const printBtn = e.target.closest("[data-print-id]");
  if (printBtn) {
    e.preventDefault();
    e.stopPropagation();
    const sid = printBtn.getAttribute("data-print-id");
    const pr = new URL(API_URL);
    pr.searchParams.set("action", "print");
    pr.searchParams.set("id", sid);
    pr.searchParams.set("key", key);
    window.open(pr.toString(), "_blank");
    return;
  }

  const editBtn = e.target.closest("[data-edit-id]");
  if (editBtn) {
    e.preventDefault();
    e.stopPropagation();
    const sid = editBtn.getAttribute("data-edit-id");
    const u = new URL("https://davidtroglin-gif.github.io/mtng-field-app/index.html");
    u.searchParams.set("edit", sid);
    u.searchParams.set("key", key);
    window.open(u.toString(), "_blank");
    return;
  }

  openDetail(rowId);
});



    function tooltipAttr(s) {
  // safe for putting into an HTML attribute
  return attrEscape(String(s ?? "").replace(/\r\n/g, "\n"));
}


    async function ownerPost(op, submissionId, extra = {}) {
      const url = new URL(API_URL);
      url.searchParams.set("action", "owner");
      url.searchParams.set("key", key);
      url.searchParams.set("_", Date.now().toString());

      const res = await fetch(url.toString(), {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ key, op, submissionId, ...extra })
      });

      const txt = await res.text();
      let json;
      try { json = JSON.parse(txt); }
      catch { throw new Error("Owner update not JSON: " + txt.slice(0, 160)); }

      if (!json.ok) throw new Error(json.error || "Owner update failed");
      return json;
    }

    function getOwnerName() {
      const k = "mtng_owner_name";
      let v = localStorage.getItem(k) || "";
      if (!v) {
        v = prompt("Printed By (name):") || "";
        if (v) localStorage.setItem(k, v);
      }
      return v;
    }

    async function openDetail(id){
      if (!key) {
        setStatus("Missing owner key. Open as: owner.html?key=YOUR_OWNER_KEY");
        return;
      }

      if (openingDetail) return;
      openingDetail = true;

      try {
        selectedId = id;
        setStatus("Loading details‚Ä¶");

        document.getElementById("markPrinted").onclick = async () => {
          try {
            setStatus("Marking Printed‚Ä¶");
            const by = getOwnerName();
            await ownerPost("printed", selectedId, { by });
            await fetchList();
            await openDetail(selectedId);
            setStatus("Printed ‚úÖ");
          } catch (e) { setStatus("Error: " + e.message); }
        };

        document.getElementById("markSubmitted").onclick = async () => {
          try {
            setStatus("Marking Submitted‚Ä¶");
            await ownerPost("submitted", selectedId);
            await fetchList();
            await openDetail(selectedId);
            setStatus("Submitted ‚úÖ");
          } catch (e) { setStatus("Error: " + e.message); }
        };

        document.getElementById("addNote").onclick = async () => {
          try {
            const note = prompt("Notes:", "") || "";
            if (!note.trim()) return;
            setStatus("Saving Note‚Ä¶");
            await ownerPost("note", selectedId, { note });
            await fetchList();
            await openDetail(selectedId);
            setStatus("Note saved ‚úÖ");
          } catch (e) { setStatus("Error: " + e.message); }
        };

        const url = new URL(API_URL);
        url.searchParams.set("action", "get");
        url.searchParams.set("id", selectedId);
        url.searchParams.set("key", key);
        url.searchParams.set("_", Date.now().toString());

        const json = await fetchJsonOrThrow(url, { cache: "no-store" });

        const p = json.payload || {};
        const f = p.fields || {};
        const r = p.repeaters || {};

        detailTitle.textContent = `${p.pageType || "Submission"} ‚Äî ${selectedId}`;
        detailMeta.textContent = `Device: ${p.deviceId || ""} ‚Ä¢ Created: ${fmtDate(p.createdAt)} ‚Ä¢ Page: ${p.pageType || ""}`;
        detailCard.style.display = "block";

        const keyFields = [
          "Customer Name","Customer Address","Customer City","Customer County","Customer Phone",
          "Service Address (if different than customers)","Date","Contractor","MLO Number","Register Number",
          "Foreman","Accepted By","MTNG On-Site Personnel","Date Completed"
        ];

        kv.innerHTML = keyFields.map(k => `
          <div style="margin:6px 0;">
            <div class="small">${escapeHtml(k)}</div>
            <div style="font-weight:700;">${escapeHtml(String(getF(f, k) || ""))}</div>
          </div>
        `).join("");

        rep.textContent = JSON.stringify(r, null, 2);
        raw.textContent = JSON.stringify(p, null, 2);

        const sketchUrl = p.media?.sketchUrl || "";
        const photos = Array.isArray(p.media?.photoUrls) ? p.media.photoUrls : [];

        sketchLinks.innerHTML = sketchUrl
          ? `<a href="${attrEscape(sketchUrl)}" target="_blank" rel="noopener">Open Sketch</a>`
          : "No sketch";

        if (sketchUrl) {
          sketchImg.src = sketchUrl;
          sketchImg.style.display = "block";
        } else {
          sketchImg.style.display = "none";
        }

        photoLinks.innerHTML = photos.length
          ? photos.map((u,i)=>`<div><a href="${attrEscape(u)}" target="_blank" rel="noopener">Photo ${i+1}</a></div>`).join("")
          : "No photos";

        photoImgs.innerHTML = photos.map(u => `<img src="${attrEscape(u)}" alt="Photo" style="margin-top:8px;" />`).join("");

        openPrintBtn.onclick = () => {
          const pr = new URL(API_URL);
          pr.searchParams.set("action","print");
          pr.searchParams.set("id", selectedId);
          pr.searchParams.set("key", key);
          window.open(pr.toString(), "_blank");
        };

        closeDetailBtn.onclick = () => {
          detailCard.style.display = "none";
          selectedId = "";
        };

        setStatus("Ready");
      } finally {
        openingDetail = false;
      }
    }


    // UI hooks
   document.getElementById("refresh").addEventListener("click", () =>
  fetchList().catch(e => setStatus("Error: " + e.message))
);

qEl.addEventListener("input", renderTable);
pageTypeEl.addEventListener("change", renderTable);




    // boot
    fetchList().catch(e => setStatus("Error: " + e.message));
  </script>
</body>
</html>
