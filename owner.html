<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTNG Owner Dashboard</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background:#f6f7f8; }
    header { position: sticky; top:0; background:white; padding:12px 14px; border-bottom:1px solid #ddd; z-index:10; }
    main { padding: 14px; max-width: 1100px; margin: 0 auto; }
    .card { background:white; border:1px solid #e5e5e5; border-radius:12px; padding:12px; margin-bottom:12px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 220px; }
    label { display:block; font-weight:700; }
    input, select, button { width:100%; padding:10px; font-size:16px; margin-top:6px; box-sizing:border-box; }
    .small { font-size: 12px; color:#666; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #ddd; padding:8px; vertical-align: top; font-size: 13px; }
    th { background:#fafafa; text-align:left; }
    tr:hover { background:#f3f7ff; cursor:pointer; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; background:#fafafa; }
    .mediaGrid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    img { max-width:100%; border-radius:12px; border:1px solid #ddd; background:white; }
    .btnrow { display:flex; gap:10px; flex-wrap: wrap; }
    .btnrow button { flex:1; min-width: 160px; }
    code { font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    @media (max-width: 900px) {
      .mediaGrid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div style="font-weight:800;">MTNG Owner Dashboard</div>
    <div class="small" id="status">Status: ‚Ä¶</div>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <div>
          <label>Search</label>
          <input id="q" placeholder="Customer, MLO, Register, Foreman, SubmissionId‚Ä¶" />
        </div>
        <div>
          <label>Page Type</label>
          <select id="pageType">
            <option value="">All</option>
            <option value="Leak Repair">Leak Repair</option>
            <option value="Mains">Mains</option>
            <option value="Retirement">Retirement</option>
            <option value="Services">Services</option>
          </select>
        </div>

        <div>
          <label>Filter</label>
          <select id="paperworkFilter">
            <option value="">All</option>
            <option value="not-turned">Not Turned In</option>
            <option value="turned">Turned In</option>
            <option value="not-printed">Not Printed</option>
            <option value="printed">Printed</option>
          </select>
        </div>

        <div>
          <label>Actions</label>
          <button id="refresh" type="button">Refresh</button>
        </div>
      </div>
      <div class="small" id="meta"></div>
    </div>

    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Submissions</div>
      <div style="overflow:auto;">
        <table id="tbl">
          <thead>
            <tr>
              <th>Synced</th>
              <th>Page</th>
              <th>Customer</th>
              <th>Date</th>
              <th>MLO</th>
              <th>Register</th>
              <th>Foreman</th>
              <th>Status</th>
              <th>SubmissionId</th>
              <th>Edit</th>
              <th>Print</th>
              <th>Add Note</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" id="detailCard" style="display:none;">
      <div class="row" style="align-items:flex-end;">
        <div>
          <div style="font-weight:800; font-size:18px;" id="detailTitle">Details</div>
          <div class="small" id="detailMeta"></div>
        </div>
        <div class="btnrow">
          <button id="openPrint" type="button">Open Print</button>
          <button id="markPrinted" type="button">Printed</button>
          <button id="markSubmitted" type="button">Submitted</button>
          <button id="addNote" type="button">Add Note</button>
          <button id="closeDetail" type="button">Close</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Key Fields</div>
          <div id="kv"></div>
        </div>
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Repeaters (quick view)</div>
          <div class="small">Print layout formats these; this is just raw reference.</div>
          <pre id="rep" style="white-space:pre-wrap; font-size:12px; margin:8px 0 0;"></pre>
        </div>
      </div>

      <div class="mediaGrid" style="margin-top:10px;">
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Sketch</div>
          <div id="sketchLinks" class="small"></div>
          <img id="sketchImg" alt="Sketch" style="display:none;" />
        </div>
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Photos</div>
          <div id="photoLinks" class="small"></div>
          <div id="photoImgs"></div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div style="font-weight:700; margin-bottom:6px;">Raw JSON</div>
        <pre id="raw" style="white-space:pre-wrap; font-size:12px; margin:0;"></pre>
      </div>
    </div>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycby4A2Ci8N6IFLB7oORb7KKThB_jqW580SV0EvG67CZ1FFoudWgLttJ8PyOiqPMKXtDiEQ/exec";

    const statusEl = document.getElementById("status");
    const metaEl = document.getElementById("meta");
    const tbody = document.getElementById("tbody");

    const qEl = document.getElementById("q");
    const pageTypeEl = document.getElementById("pageType");
    const paperworkFilterEl = document.getElementById("paperworkFilter");

    const detailCard = document.getElementById("detailCard");
    const detailTitle = document.getElementById("detailTitle");
    const detailMeta = document.getElementById("detailMeta");
    const kv = document.getElementById("kv");
    const rep = document.getElementById("rep");
    const raw = document.getElementById("raw");
    const openPrintBtn = document.getElementById("openPrint");
    const closeDetailBtn = document.getElementById("closeDetail");

    const sketchImg = document.getElementById("sketchImg");
    const sketchLinks = document.getElementById("sketchLinks");
    const photoLinks = document.getElementById("photoLinks");
    const photoImgs = document.getElementById("photoImgs");

    const key = new URLSearchParams(location.search).get("key") || "";

    let items = [];
    let selectedId = "";
    let openingDetail = false;

    function setStatus(msg){
      statusEl.textContent = "Status: " + msg;
    }

    function fmtDate(v){
      if (!v) return "";
      const d = new Date(v);
      if (isNaN(d.getTime())) return String(v);
      return d.toLocaleString();
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    function attrEscape(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function normKey(k){
      return String(k ?? "").replace(/\s+/g, " ").trim();
    }

    // Aliases let owner dashboard show the same value even if the form label changed
    const FIELD_ALIASES = {
      "Date Completed": ["Date Completed", "Date Repair Completed", "Date Completed (Repair)"],
      "MTNG On-Site Personnel": ["MTNG On-Site Personnel", "MTNG On Site Personnel", "MTNG On-Site Personell", "MTNG On-Site Personnel "],
      "Foreman": ["Foreman"],
      "Accepted By": ["Accepted By", "Accepted by"],
      "Customer Name": ["Customer Name", "Customer"],
      "Register Number": ["Register Number", "Register #"],
      "MLO Number": ["MLO Number", "MLO #"],
      "Customer Address": ["Customer Address", "Address"],
      "Customer City": ["Customer City", "City"],
      "Customer County": ["Customer County", "County"],
      "Customer Phone": ["Customer Phone", "Phone"],
      "Service Address (if different than customers)": ["Service Address (if different than customers)", "Service Address"],
      "Date": ["Date"],
      "Contractor": ["Contractor"],
    };

    function getF(fields, label){
      if (!fields) return "";
      const want = FIELD_ALIASES[label] || [label];

      // Build a normalized lookup once per call (fields are small enough; OK)
      const map = {};
      Object.keys(fields).forEach(k => { map[normKey(k)] = fields[k]; });

      for (const candidate of want) {
        const v = map[normKey(candidate)];
        if (v !== undefined && v !== null && String(v).trim() !== "") return v;
      }
      return "";
    }

    async function fetchJsonOrThrow(url, fetchOpts = {}) {
      const res = await fetch(url.toString(), { cache: "no-store", ...fetchOpts });
      const txt = await res.text();

      let json;
      try { json = JSON.parse(txt); }
      catch { throw new Error(`Not valid JSON. HTTP ${res.status}. First 160: ${txt.slice(0,160)}`); }

      if (!json.ok) throw new Error(json.error || "Request failed");
      return json;
    }

    async function fetchList(){
      if (!key) {
        setStatus("Missing owner key. Open as: owner.html?key=YOUR_OWNER_KEY");
        return;
      }

      setStatus("Loading list‚Ä¶");

      const url = new URL(API_URL);
      url.searchParams.set("action", "list");
      url.searchParams.set("key", key);
      url.searchParams.set("_", Date.now().toString()); // cache-bust

      const json = await fetchJsonOrThrow(url, { cache: "no-store" });
      items = json.items || [];

      setStatus(`Loaded ${items.length}`);
      renderTable();
    }

    function samePageType(a, b){
      return String(a ?? "").trim().toLowerCase() === String(b ?? "").trim().toLowerCase();
    }

    function matchesFilters(it){
      const q = (qEl.value || "").trim().toLowerCase();
      const pt = pageTypeEl.value || "";
      const pw = paperworkFilterEl.value || "";

      if (pt && !samePageType(it.pageType, pt)) return false;

      if (pw === "not-turned" && it.turnedInOn) return false;
      if (pw === "turned" && !it.turnedInOn) return false;
      if (pw === "not-printed" && it.printedAt) return false;
      if (pw === "printed" && !it.printedAt) return false;

      if (!q) return true;

      const hay = [
        it.customerName, it.date, it.mloNumber, it.registerNumber,
        it.foreman, it.acceptedBy, it.mtngOnSitePersonnel, it.dateCompleted,
        it.submissionId, it.pageType, it.status, it.printedBy, it.notes
      ].join(" ").toLowerCase();

      return hay.includes(q);
    }

    function renderTable(){
  const filtered = items.filter(matchesFilters);
  metaEl.textContent = `Showing: ${filtered.length} of ${items.length}`;

  tbody.innerHTML = filtered.map(it => `
    <tr data-id="${attrEscape(it.submissionId)}">
      <td>${escapeHtml(fmtDate(it.syncedAt))}</td>
      <td>${escapeHtml(it.pageType || "")}</td>
      <td>${escapeHtml(it.customerName || "")}</td>
      <td>${escapeHtml(it.date || "")}</td>
      <td>${escapeHtml(it.mloNumber || "")}</td>
      <td>${escapeHtml(it.registerNumber || "")}</td>
      <td>${escapeHtml(it.foreman || "")}</td>
      <td><span class="pill">${escapeHtml(it.status || "")}</span></td>
      <td><code>${escapeHtml(it.submissionId || "")}</code></td>

      <!-- Edit -->
      <td>
        <button type="button"
          class="btnEdit"
          data-id="${attrEscape(it.submissionId)}"
          style="width:auto;padding:6px 10px;font-size:13px;">
          Edit
        </button>
      </td>

      <!-- Print -->
      <td>
        <button type="button"
          class="btnPrint"
          data-id="${attrEscape(it.submissionId)}"
          style="width:auto;padding:6px 10px;font-size:13px;">
          Print
        </button>
      </td>

      <!-- Add Note -->
      <td>
        <button type="button"
          class="btnNote"
          data-id="${attrEscape(it.submissionId)}"
          style="width:auto;padding:6px 10px;font-size:13px;">
          + Note
        </button>
      </td>

      <!-- Notes preview -->
        <td title="${tooltipAttr(it.notes || "")}" style="text-align:center;">
          ${it.notes && String(it.notes).trim() ? "üìù" : ""}
      </td>
    </tr>
  `).join("");
}

    // Row click
    tbody.addEventListener("click", async (e) => {
  const btnEdit  = e.target.closest(".btnEdit");
  const btnPrint = e.target.closest(".btnPrint");
  const btnNote  = e.target.closest(".btnNote");

  // If a button was clicked, don't also treat it like a row click
  if (btnEdit || btnPrint || btnNote) e.stopPropagation();

  // EDIT -> open detail pane
  if (btnEdit) {
    const id = btnEdit.dataset.id;
    openDetail(id);
    return;
  }

  // PRINT -> open print view + mark printed
  if (btnPrint) {
    const id = btnPrint.dataset.id;
    try {
      const by = getOwnerName();

      // open print view
      const pr = new URL(API_URL);
      pr.searchParams.set("action","print");
      pr.searchParams.set("id", id);
      pr.searchParams.set("key", key);
      window.open(pr.toString(), "_blank");

      // mark printed
      setStatus("Marking Printed‚Ä¶");
      await ownerPost("printed", id, { by });
      await fetchList();
      setStatus("Printed ‚úÖ");
    } catch (err) {
      setStatus("Error: " + err.message);
    }
    return;
  }

  // ADD NOTE -> prompt + save
  if (btnNote) {
    const id = btnNote.dataset.id;
    try {
      const existing = (items.find(x => x.submissionId === id)?.notes || "").trim();
      const note = prompt("Notes:", existing) || "";
      if (!note.trim()) return;

      setStatus("Saving Note‚Ä¶");
      await ownerPost("note", id, { note });
      await fetchList();
      setStatus("Note saved ‚úÖ");
    } catch (err) {
      setStatus("Error: " + err.message);
    }
    return;
  }

  // default: row click opens detail
  const tr = e.target.closest("tr");
  if (!tr) return;
  const id = tr.dataset.id;
  if (!id) return;
  openDetail(id);
});

    function tooltipAttr(s) {
  // safe for putting into an HTML attribute
  return attrEscape(String(s ?? "").replace(/\r\n/g, "\n"));
}


    async function ownerPost(op, submissionId, extra = {}) {
      const url = new URL(API_URL);
      url.searchParams.set("action", "owner");
      url.searchParams.set("key", key);
      url.searchParams.set("_", Date.now().toString());

      const res = await fetch(url.toString(), {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ key, op, submissionId, ...extra })
      });

      const txt = await res.text();
      let json;
      try { json = JSON.parse(txt); }
      catch { throw new Error("Owner update not JSON: " + txt.slice(0, 160)); }

      if (!json.ok) throw new Error(json.error || "Owner update failed");
      return json;
    }

    function getOwnerName() {
      const k = "mtng_owner_name";
      let v = localStorage.getItem(k) || "";
      if (!v) {
        v = prompt("Printed By (name):") || "";
        if (v) localStorage.setItem(k, v);
      }
      return v;
    }

    async function openDetail(id){
      if (!key) {
        setStatus("Missing owner key. Open as: owner.html?key=YOUR_OWNER_KEY");
        return;
      }

      if (openingDetail) return;
      openingDetail = true;

      try {
        selectedId = id;
        setStatus("Loading details‚Ä¶");

        document.getElementById("markPrinted").onclick = async () => {
          try {
            setStatus("Marking Printed‚Ä¶");
            const by = getOwnerName();
            await ownerPost("printed", selectedId, { by });
            await fetchList();
            await openDetail(selectedId);
            setStatus("Printed ‚úÖ");
          } catch (e) { setStatus("Error: " + e.message); }
        };

        document.getElementById("markSubmitted").onclick = async () => {
          try {
            setStatus("Marking Submitted‚Ä¶");
            await ownerPost("submitted", selectedId);
            await fetchList();
            await openDetail(selectedId);
            setStatus("Submitted ‚úÖ");
          } catch (e) { setStatus("Error: " + e.message); }
        };

        document.getElementById("addNote").onclick = async () => {
          try {
            const note = prompt("Notes:", "") || "";
            if (!note.trim()) return;
            setStatus("Saving Note‚Ä¶");
            await ownerPost("note", selectedId, { note });
            await fetchList();
            await openDetail(selectedId);
            setStatus("Note saved ‚úÖ");
          } catch (e) { setStatus("Error: " + e.message); }
        };

        const url = new URL(API_URL);
        url.searchParams.set("action", "get");
        url.searchParams.set("id", selectedId);
        url.searchParams.set("key", key);
        url.searchParams.set("_", Date.now().toString());

        const json = await fetchJsonOrThrow(url, { cache: "no-store" });

        const p = json.payload || {};
        const f = p.fields || {};
        const r = p.repeaters || {};

        detailTitle.textContent = `${p.pageType || "Submission"} ‚Äî ${selectedId}`;
        detailMeta.textContent = `Device: ${p.deviceId || ""} ‚Ä¢ Created: ${fmtDate(p.createdAt)} ‚Ä¢ Page: ${p.pageType || ""}`;
        detailCard.style.display = "block";

        const keyFields = [
          "Customer Name","Customer Address","Customer City","Customer County","Customer Phone",
          "Service Address (if different than customers)","Date","Contractor","MLO Number","Register Number",
          "Foreman","Accepted By","MTNG On-Site Personnel","Date Completed"
        ];

        kv.innerHTML = keyFields.map(k => `
          <div style="margin:6px 0;">
            <div class="small">${escapeHtml(k)}</div>
            <div style="font-weight:700;">${escapeHtml(String(getF(f, k) || ""))}</div>
          </div>
        `).join("");

        rep.textContent = JSON.stringify(r, null, 2);
        raw.textContent = JSON.stringify(p, null, 2);

        const sketchUrl = p.media?.sketchUrl || "";
        const photos = Array.isArray(p.media?.photoUrls) ? p.media.photoUrls : [];

        sketchLinks.innerHTML = sketchUrl
          ? `<a href="${attrEscape(sketchUrl)}" target="_blank" rel="noopener">Open Sketch</a>`
          : "No sketch";

        if (sketchUrl) {
          sketchImg.src = sketchUrl;
          sketchImg.style.display = "block";
        } else {
          sketchImg.style.display = "none";
        }

        photoLinks.innerHTML = photos.length
          ? photos.map((u,i)=>`<div><a href="${attrEscape(u)}" target="_blank" rel="noopener">Photo ${i+1}</a></div>`).join("")
          : "No photos";

        photoImgs.innerHTML = photos.map(u => `<img src="${attrEscape(u)}" alt="Photo" style="margin-top:8px;" />`).join("");

        openPrintBtn.onclick = () => {
          const pr = new URL(API_URL);
          pr.searchParams.set("action","print");
          pr.searchParams.set("id", selectedId);
          pr.searchParams.set("key", key);
          window.open(pr.toString(), "_blank");
        };

        closeDetailBtn.onclick = () => {
          detailCard.style.display = "none";
          selectedId = "";
        };

        setStatus("Ready");
      } finally {
        openingDetail = false;
      }
    }

    // UI hooks
    document.getElementById("refresh").addEventListener("click", () => fetchList().catch(e => setStatus("Error: " + e.message)));
    qEl.addEventListener("input", renderTable);
    pageTypeEl.addEventListener("change", renderTable);
    paperworkFilterEl.addEventListener("change", renderTable);

    // boot
    fetchList().catch(e => setStatus("Error: " + e.message));
  </script>
</body>
</html>
