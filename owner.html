<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTNG Owner Dashboard</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; background:#f6f7f8; }
    header { position: sticky; top:0; background:white; padding:12px 14px; border-bottom:1px solid #ddd; }
    main { padding: 14px; max-width: 1100px; margin: 0 auto; }
    .card { background:white; border:1px solid #e5e5e5; border-radius:12px; padding:12px; margin-bottom:12px; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 220px; }
    input, select, button { width:100%; padding:10px; font-size:16px; margin-top:6px; box-sizing:border-box; }
    .small { font-size: 12px; color:#666; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #ddd; padding:8px; vertical-align: top; font-size: 13px; }
    th { background:#fafafa; text-align:left; }
    tr:hover { background:#f3f7ff; cursor:pointer; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; background:#fafafa; }
    .mediaGrid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    img { max-width:100%; border-radius:12px; border:1px solid #ddd; background:white; }
    .btnrow { display:flex; gap:10px; }
    .btnrow button { flex:1; }
    code { font-size: 12px; }
    @media (max-width: 900px) { .mediaGrid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <div style="font-weight:800;">MTNG Owner Dashboard</div>
    <div class="small" id="status">Status: …</div>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <div>
          <label>Search</label>
          <input id="q" placeholder="Customer, MLO, Register, Foreman, SubmissionId…" />
        </div>
        <div>
          <label>Page Type</label>
          <select id="pageType">
            <option value="">All</option>
            <option>Leak Repair</option>
            <option>Mains</option>
            <option>Retirement</option>
            <option>Services</option>
          </select>
        </div>
        <div>
          <label>Status</label>
          <select id="statusFilter">
            <option value="">All</option>
            <option>RECEIVED</option>
            <option>UPDATED</option>
          </select>
        </div>
        <div>
          <label>Actions</label>
          <button id="refresh">Refresh</button>
        </div>
      </div>
      <div class="small" id="meta"></div>
    </div>

    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Submissions</div>
      <div style="overflow:auto;">
        <table id="tbl">
          <thead>
            <tr>
              <th>Synced</th>
              <th>Page</th>
              <th>Customer</th>
              <th>Date</th>
              <th>MLO</th>
              <th>Register</th>
              <th>Foreman</th>
              <th>Status</th>
              <th>SubmissionId</th>
              <th>Printed</th>
              <th>Printed By</th>
              <th>Turned In</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" id="detailCard" style="display:none;">
      <div class="row" style="align-items:flex-end;">
        <div>
          <div style="font-weight:800; font-size:18px;" id="detailTitle">Details</div>
          <div class="small" id="detailMeta"></div>
        </div>
        <div class="btnrow">
          <button id="openPrint" type="button">Open Print</button>
          <button id="markPrinted" type="button">Printed</button>
          <button id="markSubmitted" type="button">Submitted</button>
          <button id="addNote" type="button">Add Note</button>
          <button id="closeDetail" type="button">Close</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Key Fields</div>
          <div id="kv"></div>
        </div>
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Repeaters (quick view)</div>
          <div class="small">We’ll format these nicely in the print layout step.</div>
          <pre id="rep" style="white-space:pre-wrap; font-size:12px; margin:8px 0 0;"></pre>
        </div>
      </div>

      <div class="mediaGrid" style="margin-top:10px;">
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Sketch</div>
          <div id="sketchLinks" class="small"></div>
          <img id="sketchImg" alt="Sketch" style="display:none;" />
        </div>
        <div class="card" style="margin:0;">
          <div style="font-weight:700; margin-bottom:6px;">Photos</div>
          <div id="photoLinks" class="small"></div>
          <div id="photoImgs"></div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div style="font-weight:700; margin-bottom:6px;">Raw JSON</div>
        <pre id="raw" style="white-space:pre-wrap; font-size:12px; margin:0;"></pre>
      </div>
    </div>
  </main>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycby4A2Ci8N6IFLB7oORb7KKThB_jqW580SV0EvG67CZ1FFoudWgLttJ8PyOiqPMKXtDiEQ/exec";

  const statusEl = document.getElementById("status");
  const metaEl = document.getElementById("meta");
  const tbody = document.getElementById("tbody");

  const qEl = document.getElementById("q");
  const pageTypeEl = document.getElementById("pageType");
  const statusFilterEl = document.getElementById("statusFilter");

  const detailCard = document.getElementById("detailCard");
  const detailTitle = document.getElementById("detailTitle");
  const detailMeta = document.getElementById("detailMeta");
  const kv = document.getElementById("kv");
  const rep = document.getElementById("rep");
  const raw = document.getElementById("raw");
  const openPrintBtn = document.getElementById("openPrint");
  const closeDetailBtn = document.getElementById("closeDetail");

  const sketchImg = document.getElementById("sketchImg");
  const sketchLinks = document.getElementById("sketchLinks");
  const photoLinks = document.getElementById("photoLinks");
  const photoImgs = document.getElementById("photoImgs");

  const key = new URLSearchParams(location.search).get("key") || "";

  let items = [];
  let selectedId = "";

  function setStatus(msg){ statusEl.textContent = "Status: " + msg; }

  function fmtDate(v){
    if (!v) return "";
    const d = new Date(v);
    if (isNaN(d.getTime())) return String(v);
    return d.toLocaleString();
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  async function fetchJsonOrThrow(url) {
    // Bust caches + avoid Safari weirdness
    url.searchParams.set("_", String(Date.now()));

    console.log("Fetching:", url.toString());

    const res = await fetch(url.toString(), { cache: "no-store" });
    const txt = await res.text(); // ALWAYS read text first

    // If Apps Script returns HTML (login page, error page), show it
    const looksLikeHtml = txt.trim().startsWith("<!doctype") || txt.trim().startsWith("<html");
    if (looksLikeHtml) {
      throw new Error(`Server returned HTML (not JSON). HTTP ${res.status}. First 120 chars: ${txt.slice(0,120)}`);
    }

    // Parse JSON safely
    let json;
    try {
      json = JSON.parse(txt);
    } catch (e) {
      throw new Error(`Response was not valid JSON. HTTP ${res.status}. First 120 chars: ${txt.slice(0,120)}`);
    }

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}. ${json?.error || "Request failed"}`);
    }
    if (!json.ok) {
      throw new Error(json.error || "Request failed");
    }
    return json;
  }

  async function fetchList(){
    if (!key) {
      setStatus("Missing owner key. Open as: owner.html?key=YOUR_OWNER_KEY");
      return;
    }

    setStatus("Loading list…");

    const url = new URL(API_URL);
    url.searchParams.set("action", "list");
    url.searchParams.set("key", key);

    const json = await fetchJsonOrThrow(url);
    items = json.items || [];

    setStatus(`Loaded ${items.length}`);
    metaEl.textContent = `Total: ${items.length}`;
    renderTable();
  }

  function matchesFilters(it){
    const q = (qEl.value || "").trim().toLowerCase();
    const pt = pageTypeEl.value || "";
    const st = statusFilterEl.value || "";

    if (pt && it.pageType !== pt) return false;
    if (st && it.status !== st) return false;

    if (!q) return true;

    const hay = [
      it.customerName, it.date, it.mloNumber, it.registerNumber,
      it.foreman, it.acceptedBy, it.submissionId, it.pageType, it.status
    ].join(" ").toLowerCase();

    return hay.includes(q);
  }

  function renderTable(){
    const filtered = items.filter(matchesFilters);
    metaEl.textContent = `Showing: ${filtered.length} of ${items.length}`;

    tbody.innerHTML = filtered.map(it => `
      <tr data-id="${escapeHtml(it.submissionId)}">
        <td>${escapeHtml(fmtDate(it.syncedAt))}</td>
        <td>${escapeHtml(it.pageType)}</td>
        <td>${escapeHtml(it.customerName || "")}</td>
        <td>${escapeHtml(it.date || "")}</td>
        <td>${escapeHtml(it.mloNumber || "")}</td>
        <td>${escapeHtml(it.registerNumber || "")}</td>
        <td>${escapeHtml(it.foreman || "")}</td>
        <td><span class="pill">${escapeHtml(it.status || "")}</span></td>
        <td><code>${escapeHtml(it.submissionId)}</code></td>
      </tr>
    `).join("");

    tbody.querySelectorAll("tr").forEach(tr => {
      tr.addEventListener("click", () => openDetail(tr.getAttribute("data-id")));
    });
  }

  async function openDetail(id){
    if (!key) {
      setStatus("Missing owner key. Open as: owner.html?key=YOUR_OWNER_KEY");
      return;
    }

    selectedId = id;
    setStatus("Loading details…");

    const url = new URL(API_URL);
    url.searchParams.set("action", "get");
    url.searchParams.set("id", id);
    url.searchParams.set("key", key);

    const json = await fetchJsonOrThrow(url);

    const p = json.payload || {};
    const f = p.fields || {};
    const r = p.repeaters || {};

    detailTitle.textContent = `${p.pageType || "Submission"} — ${id}`;
    detailMeta.textContent = `Device: ${p.deviceId || ""} • Created: ${fmtDate(p.createdAt)} • Page: ${p.pageType || ""}`;
    detailCard.style.display = "block";

    const keyFields = [
      "Customer Name","Customer Address","Customer City","Customer County","Customer Phone",
      "Service Address (if different than customers)","Date","Contractor","MLO Number","Register Number",
      "Foreman","Accepted By","MTNG On-Site Personnel","Date Completed"
    ];

    kv.innerHTML = keyFields.map(k => `
      <div style="margin:6px 0;">
        <div class="small">${escapeHtml(k)}</div>
        <div style="font-weight:700;">${escapeHtml(f[k] || "")}</div>
      </div>
    `).join("");

    rep.textContent = JSON.stringify(r, null, 2);
    raw.textContent = JSON.stringify(p, null, 2);

    const sketchUrl = p.media?.sketchUrl || "";
    const photos = Array.isArray(p.media?.photoUrls) ? p.media.photoUrls : [];

    sketchLinks.innerHTML = sketchUrl ? `<a href="${sketchUrl}" target="_blank">Open Sketch</a>` : "No sketch";
    if (sketchUrl) {
      sketchImg.src = sketchUrl;
      sketchImg.style.display = "block";
    } else {
      sketchImg.style.display = "none";
    }

    photoLinks.innerHTML = photos.length
      ? photos.map((u,i)=>`<div><a href="${u}" target="_blank">Photo ${i+1}</a></div>`).join("")
      : "No photos";

    photoImgs.innerHTML = photos.map(u => `<img src="${u}" alt="Photo" style="margin-top:8px;" />`).join("");

    openPrintBtn.onclick = () => {
      const pr = new URL(API_URL);
      pr.searchParams.set("action","print");
      pr.searchParams.set("id", id);
      pr.searchParams.set("key", key);
      window.open(pr.toString(), "_blank");
    };

    closeDetailBtn.onclick = () => {
      detailCard.style.display = "none";
      selectedId = "";
    };

    setStatus("Ready");
  }

  document.getElementById("refresh").addEventListener("click", () => fetchList().catch(e => setStatus("Error: " + e.message)));
  qEl.addEventListener("input", renderTable);
  pageTypeEl.addEventListener("change", renderTable);
  statusFilterEl.addEventListener("change", renderTable);

  // boot
  fetchList().catch(e => setStatus("Error: " + e.message));
</script>

</body>
</html>
